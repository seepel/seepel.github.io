<!DOCTYPE HTML>

<html>
  <head>
    <meta charset="utf-8">
    <title>Using PostgreSQL included with Lion Server</title>
    <meta name="description" content="Twitter Bootstrap Basic Tab Based Navigation Example"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="/css/custom.css" rel="stylesheet"/>
    <link href="/webfonts/ss-social.css" rel="stylesheet"/>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29573574-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <header>

    <h1><a class="inactive" href="/">SEANP<strong>LYNCH</strong></a></h1>

    <div class="navbar">
    <div class="navbar-inner">
    <div class="container">
    <ul class="nav">

      <li><a class="active" href="/blog">BLOG</a></li>

      <li><a href="/contact">CONTACT</a></li>

      <li class="ss-icon"><a href="/rss.xml" class="ss-icon">RSS</a></li>

    </ul>
    </div>
    </div>
    </div>
    </header>
    <div class="content">
  <div id="post">
    <p class="meta_date">
      <span class="day">29</span>
      <span class="calendar">
      <span class="month">Feb</span>
      <span class="year">2012</span>
    </span>
    </p>
    <h2>Using PostgreSQL included with Lion Server</h2>
    <p>In Lion Server Apple has moved from MySQL to PostgreSQL. You may find yourself in a situation as I have where you wish to use a web application that requires a database (WordPress for example), but don’t wish to install MySQL when the PostgreSQL server you have will do fine. There are a number of sources out there on how to get this done, but the information seems to be scattered across different corners of the internet. In particular these <a href="http://www.mactasia.co.uk/using-postgresql-in-lion-server">two</a> <a href="https://discussions.apple.com/thread/3199015?start=0&amp;tstart=0">links</a> contain all the information included in this post, but sifting through them was a bit of a pain for me. For this reason I thought I would give my take on how to get this done.<!-- more --></p>
<p>In short we are going to get PostgreSQL up and running, create a super user, create a new database to be used with an application, create a user for that application, and finally give that user access to the database. A quick note, throughout the code in this article you will find entries that are prepended by either lionserver:~ or databasename=#, these are command prompts and are not meant to be typed in, but rather serve to distinguish commands from output.</p>
<p>First up we need to make sure that the PostgreSQL server is running. We’re going to do this with the command serveradmin. serveradmin is a command line tool that allows you to control the various services that Lion Server has to offer. In case you haven’t used this tool before lets get a flavor of how it works.</p>
<div class="highlight"><pre><code class="bash">lionserver:~ serveradmin
Usage: serveradmin <span class="o">[</span>-dhvx<span class="o">]</span> <span class="o">[</span>list | start | stop | status | fullstatus | settings | <span class="nb">command</span><span class="o">]</span> <span class="o">[</span> <span class="o">[</span> <span class="o">=</span>  <span class="o">]]</span>
 
  -h, --help     display this message
  -v, --version  display version info
  -d, --debug    print <span class="nb">command</span>
  -x, --xml      print output as XML plist
Examples:
serveradmin list
        --Lists all services
serveradmin start afp
        --Starts afp server
serveradmin stop ftp
        --Stops ftp server
serveradmin status web
        --Returns current status of the web server
serveradmin fullstatus web
        --Returns more <span class="nb">complete </span>status of the web server
serveradmin settings afp
        --Returns all afp configuration parameters
serveradmin settings afp:guestAccess
        --Returns afp guestAccess attribute
serveradmin settings afp:guestAccess <span class="o">=</span> yes
        --Sets afp guestAccess to <span class="nb">true</span>
serveradmin settings
        --Takes settings commands like above from stdin
serveradmin <span class="nb">command </span>afp:command <span class="o">=</span> getConnectedUsers
        --Used to perform service specific commands
serveradmin <span class="nb">command</span>
        --Takes stdin to define generic <span class="nb">command </span>that requires other parameters
</code></pre></div><p>Ok that’s great now we see that there is a list function lets try that.</p>
<div class="highlight"><pre><code class="bash">lionserver:~  serveradmin list
serveradmin must be run as root
</code></pre></div><p>That’s ok, we just need to run this command with an sudo.</p>
<div class="highlight"><pre><code class="bash">lionserver:~ sudo serveradmin list
Password:
accounts
addressbook
afp
bonjour
calendar
certs
config
devicemgr
dhcp
dirserv
dns
filebrowser
info
ipfilter
jabber
mail
nat
netboot
network
nfs
notification
pcast
pcastlibrary
postgres
radius
sharing
signaler
smb
swupdate
vpn
web
wiki
xgrid
xsan
</code></pre></div><p>There it is the service is called postgres. Remember when we took a look how the command worked? The usage info told us that we can start services, let’s try that.</p>
<div class="highlight"><pre><code class="bash">lionserver:~ sudo serveradmin start postgres
postgres:state <span class="o">=</span> <span class="s2">&quot;RUNNING&quot;</span>
</code></pre></div><p>And now PostgreSQL is running! Great, now comes the tricky part. Lion Server has a special user that has access to the PostgreSQL server, the user name is \_postgres. But personally I don’t want to have to remember to log in as this other user every time I want to manipulate PostgreSQL. So let’s create a PostgreSQL user for our username. First we need to log into PostgreSQL</p>
<div class="highlight"><pre><code class="bash">lionserver:~ sudo -u <span class="se">\_</span>postgres psql template1
</code></pre></div><p>Then once in PostgreSQL we are going to create a role with the same username as our login, for the purposes of this tutorial we will use username and a randomly generated password QEGNRWXvxewJ42LdD. Then we will exit out of PostgreSQL with the \q command.</p>
<div class="highlight"><pre><code class="bash"><span class="nv">template1</span><span class="o">=</span><span class="c"># CREATE ROLE username WITH superuser password &#39;QEGNRWXvxewJ42LdD&#39;;</span>
<span class="nv">template1</span><span class="o">=</span><span class="c"># \q</span>
</code></pre></div><p>Next we want to add our login username to the PostgreSQL Users Group. The easiest way to do this is to download the Server Admin Tools package. Launch the tool and launch the Workgroups application, in the menu bar click View &#8594; Workgroups. You will need to login with an administrator account. Then in the Workgroups application you will click View &#8594; Show System Records. This will expand the visible list to show everything. Find your login user, and then click the Groups Tab. Find the PostgreSQL Users group and add it. Now you can execute the psql command without fiddling around with the \_postgres user.</p>
<p>By default, Lion Server will launch the postgres service with the option listen\_addresses=&quot;&quot;, but our web app needs to connect to the service through an IP address. So fire up your favorite text editor and point it towards /System/Library/LaunchDaemons/org.postgresql.postgres.plist. In this file you want to hunt down the line,</p>
<div class="highlight"><pre><code class="sql"><span class="k">listen</span><span class="err">\</span><span class="n">_addresses</span><span class="o">=</span>
</code></pre></div><p>and replace it with</p>
<div class="highlight"><pre><code class="sql"><span class="k">listen</span><span class="err">\</span><span class="n">_addresses</span><span class="o">=</span><span class="ss">&quot;127.0.0.1&quot;</span>
</code></pre></div><p>Finally we are ready to create our database and application user. Your particular web application may have its own directions on this, if so you should be done with this tutorial. But we will continue to complete a database setup for WordPress.</p>
<p>We’ll create our database with the convenient command createdb, create wordpressuser with the command createuser and then login to the database.</p>
<div class="highlight"><pre><code class="sql"><span class="n">lionserver</span><span class="p">:</span><span class="o">~</span> <span class="k">createdb</span> <span class="n">wordpressdb</span>
<span class="n">lionserver</span><span class="p">:</span><span class="o">~</span> <span class="k">createuser</span>
<span class="n">Enter</span> <span class="n">name</span> <span class="k">of</span> <span class="k">role</span> <span class="k">to</span> <span class="k">add</span><span class="p">:</span> <span class="n">wordpressuser</span>
<span class="n">Shall</span> <span class="n">the</span> <span class="k">new</span> <span class="k">role</span> <span class="n">be</span> <span class="n">a</span> <span class="n">superuser</span><span class="o">?</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="n">n</span>
<span class="n">Shall</span> <span class="n">the</span> <span class="k">new</span> <span class="k">role</span> <span class="n">be</span> <span class="n">allowed</span> <span class="k">to</span> <span class="k">create</span> <span class="n">databases</span><span class="o">?</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="n">n</span>
<span class="n">Shall</span> <span class="n">the</span> <span class="k">new</span> <span class="k">role</span> <span class="n">be</span> <span class="n">allowed</span> <span class="k">to</span> <span class="k">create</span> <span class="k">more</span> <span class="k">new</span> <span class="n">roles</span><span class="o">?</span> <span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="n">n</span>
<span class="n">lionserver</span><span class="p">:</span><span class="o">~</span> <span class="n">psql</span> <span class="o">-</span><span class="n">d</span> <span class="n">wordpressdb</span>
</code></pre></div><p>Once in PostgreSQL we’ll give wordpressuser permissions on wordpressdb and assign a randomly generated password.</p>
<div class="highlight"><pre><code class="sql"><span class="n">wordpressdb</span><span class="o">=#</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">privileges</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">wordpressdb</span> <span class="k">TO</span> <span class="n">wordpressuse</span><span class="p">;</span>
<span class="n">wordpressdb</span><span class="o">=#</span> <span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">wordpressuser</span> <span class="n">password</span> <span class="s1">&#39;NvUrYgnz4DRfbXm7y&#39;</span><span class="p">;</span>
<span class="n">wordpressdb</span><span class="o">=#</span> <span class="err">\</span><span class="n">q</span>
</code></pre></div><p>And we’re done!</p>
  </div>
  <div class="pagination">
    
    
    <a href="/blog/extending-cocos2d-ccsprite-to-handle-touches" class="next">Extending cocos2d CCSprite to Handle Touches<span class="arrow"> →</span></a>
    
  </div>
</div>


    <footer>
      <ul class="social horizontal">
      <li><a href="http://github.com/seepel" class="ss-icon ss-social-circle">githuboctocat</a></li>
      <li><a href="http://twitter.com/seepel" class="ss-icon ss-social-circle">twitter</a></li>
      <li><a href="http://www.linkedin.com/pub/sean-lynch/4b/309/997" class="ss-icon ss-social-circle">linkedin</a></li>

      <li><a href="/rss.xml" class="ss-icon ss-social-circle">RSS</a></li>

      </ul>
      <p class="copyright"> Copyright © Sean Lynch 2013 </p>
    </footer>
  </body>
</html>
