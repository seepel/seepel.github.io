<!DOCTYPE HTML>

<html>
  <head>
    <meta charset="utf-8">
    <title>Extending cocos2d CCSprite to Handle Touches</title>
    <meta name="description" content="Twitter Bootstrap Basic Tab Based Navigation Example"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="/css/custom.css" rel="stylesheet"/>
    <link href="/webfonts/ss-social.css" rel="stylesheet"/>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29573574-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>
  <body>
    <header>

    <h1><a class="inactive" href="/">SEANP<strong>LYNCH</strong></a></h1>

    <div class="navbar">
    <div class="navbar-inner">
    <div class="container">
    <ul class="nav">

      <li><a class="active" href="/blog">BLOG</a></li>

      <li><a href="/contact">CONTACT</a></li>

      <li class="ss-icon"><a href="/rss.xml" class="ss-icon">RSS</a></li>

    </ul>
    </div>
    </div>
    </div>
    </header>
    <div class="content">
  <div id="post">
    <p class="meta_date">
      <span class="day">04</span>
      <span class="calendar">
      <span class="month">Mar</span>
      <span class="year">2012</span>
    </span>
    </p>
    <h2>Extending cocos2d CCSprite to Handle Touches</h2>
    <h3>Extending CCSprite Makes My Life Easier</h3>
<p>While developing a couple of games that I am currently working on I ended up finding a need to have a CCSprite that would trigger a particular selector. I wanted something lightweight that I could just throw into anything. So I went about writing a quick subclass of CCSprite that at first I thought would be a bit of a throw away one time use thing. It turned out however to be simple and reusable and I find myself reusing the class all over the place, enter ClickableSprite.</p>
<p>The concept is dead simple create a subclass of CCSprite adhering to CCTargetedTouchDelegate, and give it a couple of properties that will store a target and selector.<!-- more --> Here’s the class definition, don’t forget to synthesize those properties though!</p>
<div class="highlight"><pre><code class="objc"><span class="k">@interface</span> <span class="nc">ClickableSprite</span> : <span class="nc">CCSprite</span> <span class="o">&lt;</span><span class="n">CCTargetedTouchDelegate</span><span class="o">&gt;</span> 
 
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">)</span> <span class="kt">id</span><span class="o">&lt;</span><span class="n">NSObject</span><span class="o">&gt;</span> <span class="n">target</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">SEL</span> <span class="n">selector</span><span class="p">;</span>
 
<span class="k">@end</span>
</code></pre></div><h3>Handling The Touches</h3>
<p>In the implementation file we’ll implement a function (containsTouchLocation:) that will test whether or not a touch is contained by the sprite. This method was lifted from some place or another, I don’t really remember.</p>
<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">containsTouchLocation:</span><span class="p">(</span><span class="n">UITouch</span> <span class="o">*</span><span class="p">)</span><span class="nv">touch</span> <span class="p">{</span>
    <span class="n">CGPoint</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">convertTouchToNodeSpaceAR:</span><span class="n">touch</span><span class="p">];</span>
    <span class="n">CGSize</span> <span class="n">size</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">contentSize</span><span class="p">;</span>
    <span class="n">CGRect</span> <span class="n">r</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> 
                          <span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> 
                          <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> 
                          <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">CGRectContainsPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Next we want to implement ccTouchBegan:withEvent and ccTouchEnded:withEvent such that when a user touches the sprite and then lifts their finger without moving it off of the sprite it will fire it’s selector.</p>
<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">ccTouchBegan:</span><span class="p">(</span><span class="n">UITouch</span> <span class="o">*</span><span class="p">)</span><span class="nv">touch</span> <span class="nf">withEvent:</span><span class="p">(</span><span class="n">UIEvent</span> <span class="o">*</span><span class="p">)</span><span class="nv">event</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">self</span> <span class="nl">containsTouchLocation:</span><span class="n">touch</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">ccTouchEnded:</span><span class="p">(</span><span class="n">UITouch</span> <span class="o">*</span><span class="p">)</span><span class="nv">touch</span> <span class="nf">withEvent:</span><span class="p">(</span><span class="n">UIEvent</span> <span class="o">*</span><span class="p">)</span><span class="nv">event</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span> <span class="nl">containsTouchLocation:</span><span class="n">touch</span><span class="p">])</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">target</span> <span class="nl">performSelector:</span><span class="n">self</span><span class="p">.</span><span class="n">selector</span> <span class="nl">withObject:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><p>Finally we will want to add the sprite as a targeted delegate to the CCTouchDispatcher singleton, we’ll just do this in the onEnter. And of course we’ll want to remove the sprite from the delegate list when it goes away (otherwise we’ll get <span class="caps">EXC</span>\<em><span class="caps">BAD</span>\</em><span class="caps">ACCESS</span> when the CCTouchDispatcher tries to get at it).</p>
<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onEnter</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">onEnter</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">CCTouchDispatcher</span> <span class="n">sharedDispatcher</span><span class="p">]</span> <span class="nl">addTargetedDelegate:</span><span class="n">self</span> <span class="nl">priority:</span><span class="mi">0</span> <span class="nl">swallowsTouches:</span><span class="n">YES</span><span class="p">];</span>
<span class="p">}</span>
 
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onExit</span> <span class="p">{</span>
    <span class="p">[[</span><span class="n">CCTouchDispatcher</span> <span class="n">sharedDispatcher</span><span class="p">]</span> <span class="nl">removeDelegate:</span><span class="n">self</span><span class="p">];</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">onExit</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><h3>Make That Target Bigger So Your Grandma Can Hit it</h3>
<p>That’s great, it works pretty well, but sometimes you want to be able to press a sprite that is kind of small, let’s just add another property clickableSize and synthesize it.</p>
<div class="highlight"><pre><code class="objc"><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="n">CGSize</span> <span class="n">clickableSize</span><span class="p">;</span>
</code></pre></div><p>Then we can modify our containsTouchLocation function to check for this like so…</p>
<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">containsTouchLocation:</span><span class="p">(</span><span class="n">UITouch</span> <span class="o">*</span><span class="p">)</span><span class="nv">touch</span> <span class="p">{</span>
    <span class="n">CGPoint</span> <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nl">convertTouchToNodeSpaceAR:</span><span class="n">touch</span><span class="p">];</span>
    <span class="n">CGSize</span> <span class="n">size</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">contentSize</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CGSizeEqualToSize</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">clickableSize</span><span class="p">,</span> <span class="n">CGSizeZero</span><span class="p">))</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">clickableSize</span><span class="p">;</span>
    <span class="n">CGRect</span> <span class="n">r</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">CGRectContainsPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h3>One More Thing</h3>
<p>Oh, and one more thing you might like is to be able to set the priority. CCTouchDispatcher will go through all of its delegates in order of priority, lower being called first. I haven’t found that I need to set the priority after it has been added to the scene so I haven’t bothered to implement that functionality. At any rate we’ll add another property touchPriority</p>
<div class="highlight"><pre><code class="objc"><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="kt">int</span> <span class="n">touchPriority</span><span class="p">;</span>
</code></pre></div><p>And then simply modify our onEnter function</p>
<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">onEnter</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="n">onEnter</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">CCTouchDispatcher</span> <span class="n">sharedDispatcher</span><span class="p">]</span> <span class="nl">addTargetedDelegate:</span><span class="n">self</span> <span class="nl">priority:</span><span class="n">self</span><span class="p">.</span><span class="n">priority</span> <span class="nl">swallowsTouches:</span><span class="n">YES</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div><p>To use the sprite you initialize it as you would a normal CCSprite, set the relevant properties, and add to a node like any other sprite as well.</p>
<div class="highlight"><pre><code class="objc"><span class="n">ClickableSprite</span> <span class="o">*</span><span class="n">sprite</span> <span class="o">=</span> <span class="p">[</span><span class="n">ClickableSprite</span> <span class="nl">spriteWithFile:</span><span class="s">@&quot;myAwesomeSprite.png&quot;</span><span class="p">];</span>
<span class="n">sprite</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
<span class="n">sprite</span><span class="p">.</span><span class="n">selector</span> <span class="o">=</span> <span class="k">@selector</span><span class="p">(</span><span class="n">myAwesomeSelector</span><span class="p">);</span> 
<span class="c1">// Or with the sprite as an argument sprite.selector = @selector(myAwesomeSelector:); </span>
<span class="c1">// which would call a function that would look like </span>
<span class="c1">// - (void)myAwesomeSelector:(ClickableSprite *)clickableSprite</span>
<span class="n">sprite</span><span class="p">.</span><span class="n">clickableSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
<span class="n">sprite</span><span class="p">.</span><span class="n">touchPriority</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div><p>Now we have a nice simple class that we can reuse over and over again.</p>
  </div>
  <div class="pagination">
    
    <a href="/blog/using-postgresql-in-lion-server" class="previous"><span class="arrow">← </span>Using PostgreSQL included with Lion Server</a>
    
    
    <a href="/blog/obligatory-blogging-like-a-hacker-post" class="next">Obligatory Blogging Like a Hacker Post<span class="arrow"> →</span></a>
    
  </div>
</div>


    <footer>
      <ul class="social horizontal">
      <li><a href="http://github.com/seepel" class="ss-icon ss-social-circle">githuboctocat</a></li>
      <li><a href="http://twitter.com/seepel" class="ss-icon ss-social-circle">twitter</a></li>
      <li><a href="http://www.linkedin.com/pub/sean-lynch/4b/309/997" class="ss-icon ss-social-circle">linkedin</a></li>

      <li><a href="/rss.xml" class="ss-icon ss-social-circle">RSS</a></li>

      </ul>
      <p class="copyright"> Copyright © Sean Lynch 2013 </p>
    </footer>
  </body>
</html>
